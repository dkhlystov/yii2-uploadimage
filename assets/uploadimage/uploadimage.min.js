$(function(){function e(e){e.preventDefault();var a=$(this);a.hasClass("loading")||a.closest(".uploadimage-item").find(":file").click()}function a(e){var a=$(this).closest(".uploadimage-widget"),i=!0;i&="files"in this,i&=void 0!==window.FormData,i&="onload"in new XMLHttpRequest,i?m(a,this.files):g(a),this.value=""}function i(e){e.preventDefault();var a=$(this).closest(".uploadimage-item");a.hasClass("crop")||a.closest(".uploadimage-widget").hasClass("nopreview")||b(a)}function t(e){e.preventDefault();var a,i;if("touchstart"===e.type){var t=e.originalEvent.changedTouches;t.length&&(a=t[0].pageX,i=t[0].pageY)}else a=e.pageX,i=e.pageY;if(void 0!==a){$(window).on("mousemove",s),$(window).on("mouseup",u),$(window).on("touchmove",s),$(window).on("touchend",u),$(window).on("touchcancel",u),H=$(this).find(".uploadimage-crop img");var o=H.parent(),n=H.position();H.data({x:n.left,y:n.top,px:a,py:i,mx:o.width()-H.width(),my:o.height()-H.height()})}}function o(e){e.preventDefault(),k($(this).closest(".uploadimage-item"))}function n(e){e.preventDefault(),M($(this).closest(".uploadimage-item"))}function d(e){e.preventDefault();var a=$(this),i=a.closest(".uploadimage-item");a.hasClass("active")?S(i):z(i)}function r(e){x()}function l(e){27==e.which&&C()}function s(e){var a,i;if("touchmove"===e.type){var t=e.originalEvent.changedTouches;t.length&&(a=t[0].pageX,i=t[0].pageY)}else a=e.pageX,i=e.pageY;if(void 0!==a){var o=H.data("x")+a-H.data("px"),n=H.data("y")+i-H.data("py"),d=H.data("mx"),r=H.data("my");d>o&&(o=d),o>0&&(o=0),r>n&&(n=r),n>0&&(n=0),H.css({left:o,top:n})}}function u(e){$(window).off("mousemove",s),$(window).off("mouseup",u),$(window).off("touchmove",s),$(window).off("touchend",u),$(window).off("touchcancel",u),O(H.closest(".uploadimage-item"))}function c(e){e.preventDefault();var a=$(this),i=a.closest(".uploadimage-item");a.closest(".uploadimage-widget").trigger("ui-btnclick",[a.data("id"),T(i),j(i)])}function f(e){var a=e.closest(".uploadimage-widget").find(".uploadimage-item").length>1;e.find("input").not(":file").prop("disabled",a)}function m(e,a){var i=e.find(".uploadimage-loader").closest(".uploadimage-item"),t=i.outerWidth(),o=i.outerHeight(),n=i.find(":file")[0].name,d=e.data("url"),r=e.data("maxSize"),l=e.data("maxCount"),s=[],u=[];void 0===l?l=1:0==l?l=null:l-=e.find(".uploadimage-item").length-1;for(var c=0,m=0;c<a.length;c++)file=a[c],file.size>r?s.push(file.name):l&&m>=l?u.push(file.name):(p(i,t,o,n,file,d),m++);null!==l&&m>=l&&i.addClass("hidden"),f(i),w(e,{errorMaxSize:s,errorMaxCount:u}),e.trigger("ui-imgload")}function p(e,a,i,t,o,n){var d=$("<div />").addClass("uploadimage-item loading").css({width:a,height:i}),r=new FormData,l=new XMLHttpRequest;d.insertBefore(e),"upload"in l&&"onprogress"in l.upload&&h(d,l,o),r.append(t,o),l.onreadystatechange=function(){if(4==l.readyState)if(200==l.status){var a=JSON.parse(l.responseText);if(a.items.length){var i=$(a.items[0]);d.replaceWith(i),v(i)}else w(d.closest(".uploadimage-widget"),a),d.remove(),e.removeClass("hidden"),f(e)}else alert(l.statusText),d.remove(),e.removeClass("hidden"),f(e)},l.open("POST",n,!0),l.send(r)}function g(e){var a=e.find(".uploadimage-loader");a.addClass("loading"),e.closest("form").ajaxSubmit({url:e.data("url"),dataType:"json",error:function(e){alert(e.statusText),a.removeClass("loading")},success:function(i){var t,o=a.closest(".uploadimage-item"),n=e.data("maxCount");n&&(n-=e.find(".uploadimage-item").length-1,i.items.splice(n),i.errorMaxCount=i.names.slice(n)),$.each(i.items,function(e,a){t=$(a).insertBefore(o),v(t)}),i.items.length==n&&o.addClass("hidden"),f(o),w(e,i),a.removeClass("loading"),e.trigger("ui-imgload")}})}function h(e,a,i){e.append('<div class="uploadimage-progress"><div /></div>');var t=e.find(".uploadimage-progress > div");a.upload.onprogress=function(e){t.css("width",e.loaded/e.total*100+"%")}}function v(e){var a=e.find("input");if(/\[\]\[[\da-z_]+\]$/i.test(a.attr("name"))){var i,t,o=-1;e.closest(".uploadimage-widget").find("input").not(":file").each(function(){(i=this.name.match(/\[(\d+)\]\[[\da-z_]+\]$/i))&&(t=parseInt(i[1]))>o&&(o=t)}),o++,a.each(function(){this.name=this.name.replace(/\[\](\[[\da-z_]+\])$/i,"["+o+"]$1")})}}function w(e,a){var i=e.data("msgMaxSize"),t=e.data("msgMaxCount"),o=e.data("msgFormat"),n=e.data("msgOther"),d="";if("errorMaxSize"in a&&a.errorMaxSize.length){var r=a.errorMaxSize.map(function(e){return'"'+e+'"'}).join(", ");d+=i.replace("{files}",r)+"\n"}if("errorMaxCount"in a&&a.errorMaxCount.length){var r=a.errorMaxCount.map(function(e){return'"'+e+'"'}).join(", ");d+=t.replace("{files}",r)+"\n"}if("errorFormat"in a&&a.errorFormat.length){var r=a.errorFormat.map(function(e){return'"'+e+'"'}).join(", ");d+=o.replace("{files}",r)+"\n"}if("errorOther"in a&&a.errorOther.length){var r=a.errorOther.map(function(e){return'"'+e+'"'}).join(", ");d+=n.replace("{files}",r)+"\n"}""!==d&&alert(d)}function b(e){var a=$('<div class="uploadimage-overlay" />').click(C),i=$('<div class="uploadimage-preview"><div class="buffer"><img></div><img class="image"><div class="loading" /><a href="#" class="close"><i class="glyphicon glyphicon-remove"></i></a></div>'),t=$(window).width(),o=$(window).height();$("body").append(a,i),a.fadeIn(200),i.css({left:(t-i.outerWidth())/2,top:(o-i.outerHeight())/2}),i.find(".close, .loading").click(function(e){e.preventDefault(),C()}),i.find(".buffer img").load(function(){i.find(".loading").css("opacity",0),i.find(".image").attr("src",this.src),x()}).attr("src",e.find(".uploadimage-image").attr("href")),$(window).on("keydown",l)}function x(){var e=$(".uploadimage-preview"),a=e.find(".buffer img"),i=e.find(".image"),t=e.width(),o=e.height(),n=$(window).width()-e.outerWidth()+t,d=$(window).height()-e.outerHeight()+o,r=a.width(),l=a.height(),s=r/l,u=n-40,c=d-40,f=r,m=l;(r>u||l>c)&&(s>u/c?(f=u,m=f/s):(m=c,f=m*s)),i.css({width:f,height:m}),i.is(":hidden")?e.animate({width:f,height:m,left:(n-f)/2,top:(d-m)/2},200,function(){i.fadeIn(200)}):e.css({width:f,height:m,left:(n-f)/2,top:(d-m)/2})}function C(){$(window).off("keydown",l),$(".uploadimage-overlay, .uploadimage-preview").fadeOut(200,function(){$(this).remove()})}function y(e,a,i){var t,o,n=e.find(".uploadimage-image"),d=e.find(".uploadimage-image > img");t=n.attr("href"),o=a.find(".uploadimage-image").attr("href"),e.find(':input[value="'+t+'"]').val(o),n.attr("href",o),t=d.attr("src"),o=a.find(".uploadimage-image > img").attr("src"),e.find(':input[value="'+t+'"]').val(o),d.replaceWith(a.find(".uploadimage-image > img")),i!==!1&&e.hasClass("crop")&&D(e,n.attr("href"));var r=a.data("token");e.find("a.uploadimage-btn").each(function(){this.href=this.href.replace(/(token=)[\da-f]+/i,"$1"+r)}),e.removeData("blocked")}function k(e){if(!e.data("blocked")){var a=e.closest(".uploadimage-widget").find(".uploadimage-loader").closest(".uploadimage-item");$.get(e.find(".uploadimage-btn.remove").attr("href")),e.remove(),a.removeClass("hidden"),f(a)}}function M(e){e.data("blocked")||(e.data("blocked",!0),$.get(e.find(".uploadimage-btn.rotate").attr("href"),function(a){y(e,$(a))}))}function z(e){if(!e.data("blocked")){e.addClass("crop").find(".uploadimage-btn.crop").addClass("active");var a=e.find(".uploadimage-image"),i=a.find("img");$crop=$('<span class="uploadimage-crop"><img></span>'),$crop.attr("style",i.attr("style")),a.append($crop),D(e,a.attr("href"))}}function D(e,a){var i=$("<div><img></div>");i.css({height:1,left:0,overflow:"hidden",position:"absolute",top:0,width:1}).appendTo("body"),i.find("img").load(function(){var a,t,o,n,d=$(this),r=e.find(".uploadimage-crop"),l=r.find("img"),s=d.width(),u=d.height(),c=s/u,f=r.width(),m=r.height();c>f/m?(t=m,a=t*c,l.data("scale",u/t)):(a=f,t=a/c,l.data("scale",s/a)),l.css({opacity:1,width:a,height:t,left:o=Math.round((f-a)/2),top:n=Math.round((m-t)/2)}).attr("src",d.attr("src")),i.remove(),l.data("croped")||(l.data("croped",!0),O(e,o,n))}).attr("src",a)}function S(e){e.find(".uploadimage-crop").remove(),e.find(".uploadimage-image img").show(),e.removeClass("crop").find(".uploadimage-btn.crop").removeClass("active")}function O(e,a,i){var t=e.find(".uploadimage-crop img"),o=t.data("scale");if(void 0===a||void 0===i){var n=t.position();void 0===a&&(a=n.left),void 0===i&&(i=n.top)}e.data("blocked",!0),$.get(e.find(".uploadimage-btn.crop").attr("href"),{x:-Math.round(a*o),y:-Math.round(i*o)},function(a){y(e,$(a),!1)})}function T(e){return F(e)}function j(e){return F(e.closest(".uploadimage-widget").find(".uploadimage-item[data-token]").not(e))}function F(e){return{button:function(a){return e.find('.uploadimage-btn[data-id="'+a+'"]')},data:function(a,i){var t={};if("string"==typeof a){if(void 0===i)return X(e,a).val();t[a]=i}else t=a;$.isPlainObject(t)&&$.each(t,function(a,i){X(e,a).val(i)})}}}function X(e,a){a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");var i=new RegExp("\\["+a+"\\]$"),t=$();return e.find("input").each(function(){return i.test(this.name)?(t=$(this),!1):void 0}),t}var H;$(document).on("click",".uploadimage-loader",e),$(document).on("change",".uploadimage-widget :file",a),$(document).on("click",".uploadimage-image",i),$(document).on("mousedown",".uploadimage-item.crop .uploadimage-image",t),$(document).on("touchstart",".uploadimage-item.crop .uploadimage-image",t),$(document).on("click",".uploadimage-btn.remove",o),$(document).on("click",".uploadimage-btn.rotate",n),$(document).on("click",".uploadimage-btn.crop",d),$(document).on("click",".uploadimage-btngroup.custom .uploadimage-btn",c),$(window).resize(r)});