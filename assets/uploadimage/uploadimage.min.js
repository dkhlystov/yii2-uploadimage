$(function(){var e;function a(a){var i,n;if(a.preventDefault(),"touchstart"===a.type){var d=a.originalEvent.changedTouches;d.length&&(i=d[0].pageX,n=d[0].pageY)}else i=a.pageX,n=a.pageY;if(void 0!==i){$(window).on("mousemove",t),$(window).on("mouseup",o),$(window).on("touchmove",t),$(window).on("touchend",o),$(window).on("touchcancel",o);var r=(e=$(this).find(".uploadimage-crop img")).parent(),l=e.position();e.data({x:l.left,y:l.top,px:i,py:n,mx:r.width()-e.width(),my:r.height()-e.height()})}}function i(e){27==e.which&&u()}function t(a){var i,t;if("touchmove"===a.type){var o=a.originalEvent.changedTouches;o.length&&(i=o[0].pageX,t=o[0].pageY)}else i=a.pageX,t=a.pageY;if(void 0!==i){var n=e.data("x")+i-e.data("px"),d=e.data("y")+t-e.data("py"),r=e.data("mx"),l=e.data("my");n<r&&(n=r),n>0&&(n=0),d<l&&(d=l),d>0&&(d=0),e.css({left:n,top:d})}}function o(a){$(window).off("mousemove",t),$(window).off("mouseup",o),$(window).off("touchmove",t),$(window).off("touchend",o),$(window).off("touchcancel",o),f(e.closest(".uploadimage-item"))}function n(e){var a=e.closest(".uploadimage-widget").find(".uploadimage-item").length>1;e.find("input").not(":file").prop("disabled",a)}function d(e,a,i,t,o,d){var s=$("<div />").addClass("uploadimage-item loading").css({width:a,height:i}),u=new FormData,c=new XMLHttpRequest;s.insertBefore(e),"upload"in c&&"onprogress"in c.upload&&function(e,a,i){e.append('<div class="uploadimage-progress"><div /></div>');var t=e.find(".uploadimage-progress > div");a.upload.onprogress=function(e){t.css("width",e.loaded/e.total*100+"%")}}(s,c),u.append(t,o),c.onreadystatechange=function(){if(4==c.readyState)if(200==c.status){var a=JSON.parse(c.responseText);if(a.items.length){var i=$(a.items[0]);s.replaceWith(i),r(i)}else l(s.closest(".uploadimage-widget"),a),s.remove(),e.removeClass("hidden"),n(e)}else alert(c.statusText),s.remove(),e.removeClass("hidden"),n(e)},c.open("POST",d,!0),c.send(u)}function r(e){var a=e.closest(".uploadimage-widget"),i=e.find("input");if(a.trigger("ui-imgload"),/\[\]\[[\da-z_]+\]$/i.test(i.attr("name"))){var t,o,n=-1;a.find("input").not(":file").each(function(){(t=this.name.match(/\[(\d+)\]\[[\da-z_]+\]$/i))&&(o=parseInt(t[1]))>n&&(n=o)}),n++,i.each(function(){this.name=this.name.replace(/\[\](\[[\da-z_]+\])$/i,"["+n+"]$1")})}}function l(e,a){var i=e.data("msgMaxSize"),t=e.data("msgMaxCount"),o=e.data("msgFormat"),n=e.data("msgOther"),d="";if("errorMaxSize"in a&&a.errorMaxSize.length){var r=a.errorMaxSize.map(function(e){return'"'+e+'"'}).join(", ");d+=i.replace("{files}",r)+"\n"}if("errorMaxCount"in a&&a.errorMaxCount.length){r=a.errorMaxCount.map(function(e){return'"'+e+'"'}).join(", ");d+=t.replace("{files}",r)+"\n"}if("errorFormat"in a&&a.errorFormat.length){r=a.errorFormat.map(function(e){return'"'+e+'"'}).join(", ");d+=o.replace("{files}",r)+"\n"}if("errorOther"in a&&a.errorOther.length){r=a.errorOther.map(function(e){return'"'+e+'"'}).join(", ");d+=n.replace("{files}",r)+"\n"}""!==d&&alert(d)}function s(){var e=$(".uploadimage-preview"),a=e.find(".buffer img"),i=e.find(".image"),t=e.width(),o=e.height(),n=$(window).width()-e.outerWidth()+t,d=$(window).height()-e.outerHeight()+o,r=a.width(),l=a.height(),s=r/l,u=n-40,c=d-40,m=r,f=l;(r>u||l>c)&&(s>u/c?f=(m=u)/s:m=(f=c)*s),i.css({width:m,height:f}),i.is(":hidden")?e.animate({width:m,height:f,left:(n-m)/2,top:(d-f)/2},200,function(){i.fadeIn(200)}):e.css({width:m,height:f,left:(n-m)/2,top:(d-f)/2})}function u(){$(window).off("keydown",i),$(".uploadimage-overlay, .uploadimage-preview").fadeOut(200,function(){$(this).remove()})}function c(e,a,i){var t,o,n=e.find(".uploadimage-image"),d=e.find(".uploadimage-image > img");t=n.attr("href"),o=a.find(".uploadimage-image").attr("href"),e.find(':input[value="'+t+'"]').val(o),n.attr("href",o),t=d.attr("src"),o=a.find(".uploadimage-image > img").attr("src"),e.find(':input[value="'+t+'"]').val(o),d.replaceWith(a.find(".uploadimage-image > img")),!1!==i&&e.hasClass("crop")&&m(e,n.attr("href"));var r=a.data("token");e.find("a.uploadimage-btn").each(function(){this.href=this.href.replace(/(token=)[\da-f]+/i,"$1"+r)}),e.removeData("blocked")}function m(e,a){var i=$("<div><img></div>");i.css({height:1,left:0,overflow:"hidden",position:"absolute",top:0,width:1}).appendTo("body"),i.find("img").on("load",function(){var a,t,o,n,d=$(this),r=e.find(".uploadimage-crop"),l=r.find("img"),s=d.width(),u=d.height(),c=s/u,m=r.width(),p=r.height();c>m/p?(a=(t=p)*c,l.data("scale",u/t)):(t=(a=m)/c,l.data("scale",s/a)),l.css({opacity:1,width:a,height:t,left:o=Math.round((m-a)/2),top:n=Math.round((p-t)/2)}).attr("src",d.attr("src")),i.remove(),l.data("croped")||(l.data("croped",!0),f(e,o,n))}).attr("src",a)}function f(e,a,i){var t=e.find(".uploadimage-crop img"),o=t.data("scale");if(void 0===a||void 0===i){var n=t.position();void 0===a&&(a=n.left),void 0===i&&(i=n.top)}e.data("blocked",!0),$.get(e.find(".uploadimage-btn.crop").attr("href"),{x:-Math.round(a*o),y:-Math.round(i*o)},function(a){c(e,$(a),!1)})}function p(e){return{button:function(a){return e.find('.uploadimage-btn[data-id="'+a+'"]')},data:function(a,i){var t={};if("string"==typeof a){if(void 0===i)return g(e,a).val();t[a]=i}else t=a;$.isPlainObject(t)&&$.each(t,function(a,i){g(e,a).val(i)})}}}function g(e,a){a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");var i=new RegExp("\\["+a+"\\]$"),t=$();return e.find("input").each(function(){if(i.test(this.name))return t=$(this),!1}),t}$(document).on("click",".uploadimage-loader",function(e){e.preventDefault();var a=$(this);a.hasClass("loading")||a.closest(".uploadimage-item").find(":file").click()}),$(document).on("change",".uploadimage-widget :file",function(e){var a=$(this).closest(".uploadimage-widget"),i=!0;i&="files"in this,i&=void 0!==window.FormData,(i&="onload"in new XMLHttpRequest)?function(e,a){var i=e.find(".uploadimage-loader").closest(".uploadimage-item"),t=i.outerWidth(),o=i.outerHeight(),r=i.find(":file")[0].name,s=e.data("url"),u=e.data("maxSize"),c=e.data("maxCount"),m=[],f=[];void 0===c?c=1:0==c?c=null:c-=e.find(".uploadimage-item").length-1;for(var p=0,g=0;p<a.length;p++)file=a[p],file.size>u?m.push(file.name):c&&g>=c?f.push(file.name):(d(i,t,o,r,file,s),g++);null!==c&&g>=c&&i.addClass("hidden");n(i),l(e,{errorMaxSize:m,errorMaxCount:f})}(a,this.files):((o=(t=a).find(".uploadimage-loader")).addClass("loading"),t.closest("form").ajaxSubmit({url:t.data("url"),dataType:"json",error:function(e){alert(e.statusText),o.removeClass("loading")},success:function(e){var a=o.closest(".uploadimage-item"),i=t.data("maxCount");i&&(i-=t.find(".uploadimage-item").length-1,e.items.splice(i),e.errorMaxCount=e.names.slice(i)),$.each(e.items,function(e,i){r($(i).insertBefore(a))}),e.items.length==i&&a.addClass("hidden"),n(a),l(t,e),o.removeClass("loading")}}));var t,o;this.value=""}),$(document).on("click",".uploadimage-image",function(e){e.preventDefault();var a=$(this).closest(".uploadimage-item");a.hasClass("crop")||a.closest(".uploadimage-widget").hasClass("nopreview")||(t=a,o=$('<div class="uploadimage-overlay" />').click(u),n=$('<div class="uploadimage-preview"><div class="buffer"><img></div><img class="image"><div class="loading" /><a href="#" class="close"><i class="glyphicon glyphicon-remove"></i></a></div>'),d=$(window).width(),r=$(window).height(),$("body").append(o,n),o.fadeIn(200),n.css({left:(d-n.outerWidth())/2,top:(r-n.outerHeight())/2}),n.find(".close, .loading").click(function(e){e.preventDefault(),u()}),n.find(".buffer img").on("load",function(){n.find(".loading").css("opacity",0),n.find(".image").attr("src",this.src),s()}).attr("src",t.find(".uploadimage-image").attr("href")),$(window).on("keydown",i));var t,o,n,d,r}),$(document).on("mousedown",".uploadimage-item.crop .uploadimage-image",a),$(document).on("touchstart",".uploadimage-item.crop .uploadimage-image",a),$(document).on("click",".uploadimage-btn.remove",function(e){e.preventDefault(),function(e){if(e.data("blocked"))return;var a=e.closest(".uploadimage-widget").find(".uploadimage-loader").closest(".uploadimage-item");$.get(e.find(".uploadimage-btn.remove").attr("href")),e.remove(),a.removeClass("hidden"),n(a)}($(this).closest(".uploadimage-item"))}),$(document).on("click",".uploadimage-btn.rotate",function(e){e.preventDefault(),function(e){if(e.data("blocked"))return;e.data("blocked",!0),$.get(e.find(".uploadimage-btn.rotate").attr("href"),function(a){c(e,$(a))})}($(this).closest(".uploadimage-item"))}),$(document).on("click",".uploadimage-btn.crop",function(e){e.preventDefault();var a=$(this),i=a.closest(".uploadimage-item");a.hasClass("active")?((t=i).find(".uploadimage-crop").remove(),t.find(".uploadimage-image img").show(),t.removeClass("crop").find(".uploadimage-btn.crop").removeClass("active")):function(e){if(e.data("blocked"))return;e.addClass("crop").find(".uploadimage-btn.crop").addClass("active");var a=e.find(".uploadimage-image"),i=a.find("img");$crop=$('<span class="uploadimage-crop"><img></span>'),$crop.attr("style",i.attr("style")),a.append($crop),m(e,a.attr("href"))}(i);var t}),$(document).on("click",".uploadimage-btngroup.custom .uploadimage-btn",function(e){e.preventDefault();var a=$(this),i=a.closest(".uploadimage-item");a.closest(".uploadimage-widget").trigger("ui-btnclick",[a.data("id"),(o=i,p(o)),(t=i,p(t.closest(".uploadimage-widget").find(".uploadimage-item[data-token]").not(t)))]);var t;var o}),$(window).resize(function(e){s()})});